<!DOCTYPE html>
<html manifest="cache-manifest.php">
	<head>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<title>Game</title>
		<link rel="stylesheet" href="game.css">
	</head>
	<body>
		<div id="screen" class="screen">
			<div id="login-stage" class="stage">
				<button class="start-button">Start</button>
			</div>

			<div id="character-introduction-stage" class="stage">
				<!-- Show the three characters to the subject, and introduce them with audio files -->
				<!-- Next, ask the subject to identify the correct character by name -->
			</div>

			<div id="game-stage" class="stage">
				<div id="option-1" class="option option-1">
					<div id="character_1" class="character character-1 character-dog"></div>
					<img class="basket basket-1" src="assets/basket.svg">
				</div>
					
				<div id="option-2" class="option option-2">
					<div id="character_2" class="character character-2 character-elephant"></div>
					<img class="basket basket-2" src="assets/basket.svg">
				</div>
				
				<div id="option-3" class="option option-3">
					<div id="character_3" class="character character-3 character-monkey"></div>
					<img class="basket basket-3" src="assets/basket.svg">
				</div>

				<div id="object" class="object"></div>

				<button class="next-button">Ga verder</button>
			</div>

			<div id="end-stage" class="stage">
				<p class="done">Klaar!</p>
			</div>
		</div>
		<script src="configuration.js"></script>
		<script src="lib/sequence.js"></script>
		<script>

		// Disable scrolling altogether
		// document.body.ontouchmove = function() {
		// 	return false;
		// };

		// Todo: implement offline cache control
		// see http://blogs.adobe.com/cantrell/archives/2011/11/building-an-offline-mobile-web-application.html

		var $ = function(id) {
			return document.getElementById(id);
		};

		var clickOnce = function(elements, callback) {
			Array.prototype.forEach.call(elements, function(element) {
				element.classList.add('clickable');
				element.onclick = function() {
					for (var j = 0; j < elements.length; ++j) {
						elements[j].classList.remove('clickable');
						elements[j].onclick = null;
					}

					callback(element);
					
					return false;
				};
			});
		};

		// Today, n is my namespace.
		var n = {};

		/* Audio resource */

		n.Audio = function(url)
		{
			this.audio = new Audio();
			this.audio.preload = 'none';
			this.audio.src = url;
		};

		n.Audio.prototype.load = function(next)
		{
			console.log('loading', this.audio.src);
			this.audio.addEventListener('loadeddata', function(e) { 
				console.log('finished loading', e.srcElement.src);
				next(); 
			});
			this.audio.addEventListener('error', function(e) { console.log("n.Audio error", e); });
			this.audio.load();
		};

		n.Audio.prototype.play = function(next)
		{
			this.audio.addEventListener('ended', function() { next(); });
			this.audio.play();
		};

		n.Audio.prototype.bindToElement = function(el)
		{
			throw new Error("n.Audio.bindToElement is not implemented");
		};

		/* Image resource */

		n.Image = function(url)
		{
			this.img = new Image();
			this.url = url;
		};

		n.Image.prototype.load = function(next)
		{
			this.img.onload = function() { next(); };
			this.img.src = this.url;
		};

		n.Image.prototype.bindToElement = function(el)
		{
			el.src = this.img.src;
		};

		/* Act */

		n.Act = function(data)
		{
			var self = this;

			this.id = data.id || undefined;

			this.stage = data.stage;

			this.resources = data.resources || {};

			this.setUp = data.setUp || function() {};

			this.tearDown = data.tearDown || function() {};

			// Bind stage to each of the callbacks
			this.scenes = data.scenes;

			this.sequence = new Sequence(data.scenes.map(function(scene) {
				return function(next) {
					scene.call(self, self.stage, next);
				};
			}));
		};

		n.Act.prototype.get = function(id)
		{
			return this.resources[id];
		};

		n.Act.prototype.bindResources = function()
		{
			for (var id in this.resources)
			{
				var el = this.stage.querySelector('*[data-resource-id="' + id + '"]');
				if (el) this.resources[id].bindToElement(el);
			}
		};

		n.Act.prototype.load = function(next)
		{
			var loading = 1;
			
			var progress = function() {
				if (--loading == 0)
					next();
			};

			for (var id in this.resources) {
				++loading;
				this.resources[id].load(progress);
			}

			// In case there are no things to load, this should be called immediately :)
			progress();
		};

		n.Act.prototype.play = function(next)
		{
			var self = this;

			this.load(function() {
				self.bindResources(self);
					
				self.stage.classList.add('current');

				self.setUp.call(self, self.stage);

				self.sequence.play(function() {
					self.stage.classList.remove('current');
					self.tearDown.call(self, self.stage);
					next();
				});
			});
		};

		var createAct = function(config)
		{
			var scenes = [];

			var resources = {
				'conversation': new n.Audio('assets/audio/conversations/' + config.audio_file_name + '.wav'),
				'cue': new n.Audio('assets/audio/cues/' + config.object + '.wav')
			};

			var templates = {
				pause: function(stage, next) {
					setTimeout(next, 200);
				},
				character_1_2_come_together: function(stage, next) {
					stage.classList.add('character-1-2-together');
					setTimeout(next, 1000);
				},
				character_1_2_walk_back: function(stage, next) {
					stage.classList.remove('character-1-2-together');
					setTimeout(next, 1000);
				},
				character_1_2_wisper: function(stage, next) {
					stage.classList.add('character-1-2-wisper');
					this.get('wisper').play(function() {
						stage.classList.remove('character-1-2-wisper');
						next();
					});
				},
				character_1_2_talk: function(stage, next) {
					stage.classList.add('character-1-2-talk');
					this.get('conversation').play(function() {
						stage.classList.remove('character-1-2-talk');
						next();
					});
				},
				character_2_3_come_together: function(stage, next) {
					stage.classList.add('character-2-3-together');
					setTimeout(next, 1000);
				},
				character_2_3_walk_back: function(stage, next) {
					stage.classList.remove('character-2-3-together');
					setTimeout(next, 1000);
				},
				character_2_3_wisper: function(stage, next) {
					stage.classList.add('character-2-3-wisper');
					this.get('wisper').play(function() {
						stage.classList.remove('character-2-3-wisper');
						next();
					});
				},
				character_2_3_talk: function(stage, next) {
					stage.classList.add('character-2-3-talk');
					this.get('conversation').play(function() {
						stage.classList.remove('character-2-3-talk');
						next();
					});
				},
				que: function(stage, next) {
					stage.classList.add('show-baskets');
					this.get('cue').play(next);
				},
				task: function(stage, next) {
					stage.classList.add('show-object');
					clickOnce(stage.querySelectorAll('.option'), function(option) {
						stage.classList.add('object-dropped-on-' + option.id);
						setTimeout(next, 1000);
					});
				},
				next_button: function(stage, next) {
					// Todo: clean up after task.
					var btn = stage.querySelector('.next-button');
					btn.classList.add('visible');
					clickOnce([btn], function() {
						btn.classList.remove('visible');
						next();
					});
				}
			};

			// Start with a little pause to put more focus on the come-together animation
			scenes.push(templates.pause);

			switch (config.type)
			{
				case 'wispering-left':
					// Wispering acts also need a wisper audio resource
					resources.wisper = new n.Audio('assets/audio/wispering.m4a');

					scenes.push(
						templates.character_1_2_come_together,
						templates.character_1_2_wisper,
						templates.character_1_2_walk_back,
						templates.character_2_3_come_together,
						templates.character_2_3_talk,
						templates.character_2_3_walk_back
					);
					break;

				case 'wispering-right':
					// Wispering acts also need a wisper audio resource
					resources.wisper = new n.Audio('assets/audio/wispering.m4a');

					scenes.push(
						templates.character_2_3_come_together,
						templates.character_2_3_wisper,
						templates.character_2_3_walk_back,
						templates.character_1_2_come_together,
						templates.character_1_2_talk,
						templates.character_1_2_walk_back
					);
					break;

				case 'talking-left':
					scenes.push(
						templates.character_1_2_come_together,
						templates.character_1_2_talk,
						templates.character_1_2_walk_back
					);
					break;

				case 'talking-right':
					scenes.push(
						templates.character_2_3_come_together,
						templates.character_2_3_talk,
						templates.character_2_3_walk_back
					);
					break;
			}

			scenes.push(
				templates.que,
				templates.task,
				templates.next_button);

			return new n.Act({
				id: config.code,
				stage: document.getElementById('game-stage'),
				resources: resources,
				scenes: scenes,
				setUp: function(stage) {
					stage.classList.add(config.type);
					stage.querySelector('.object').classList.add(config.object);
					stage.querySelector('.character-2').classList.add(config.speaker);

					// Which character is the remaining character?
					var characters = ['aap', 'hond', 'olifant'];
					characters.splice(characters.indexOf(config.speaker), 1);
					characters.splice(characters.indexOf(config.addressee), 1);
					var spare = characters[0];
					
					// Assign character to one of the three options/places
					switch (config.type) {
						case 'talking-left':
						case 'wispering-right':
							stage.querySelector('.character-1').classList.add(config.addressee);
							stage.querySelector('.character-3').classList.add(spare);
							break;

						case 'talking-right':
						case 'wispering-left':
							stage.querySelector('.character-1').classList.add(spare);
							stage.querySelector('.character-3').classList.add(config.addressee);
							break;
					}
				},
				tearDown: function(stage) {
					// Clear the type
					stage.classList.remove(config.type);

					// Clear all the scenarios.
					stage.classList.remove('show-object');
					stage.classList.remove('show-baskets');
					stage.classList.remove('object-dropped-on-option-1');
					stage.classList.remove('object-dropped-on-option-2');
					stage.classList.remove('object-dropped-on-option-3');
					
					// Remove the configured object
					stage.querySelector('.object').classList.remove(config.object);

					// Remove the characters from the options/places.
					['aap', 'hond', 'olifant'].forEach(function(character) {
						for (var i = 1; i <= 3; ++i)
							stage.querySelector('.character-' + i).classList.remove(character);
					});
				}
			});
		};
		
		var acts = [];

		// Login act
		acts.push(new n.Act({
			stage: document.getElementById('login-stage'),
			scenes: [
				function(stage, next) {
					clickOnce([stage.querySelector('.start-button')], next);
				}
			]
		}));

		// Game acts
		configuration.no_report_items.map(createAct).forEach(function(act) { acts.push(act); });
		
		// Thank you! act
		acts.push(new n.Act({
			stage: document.getElementById('end-stage'),
			scenes: [
				function(stage, next) {
					// that's it :)
				}
			]
		}));

		var main = new Sequence(acts.map(function(act) { return act.play.bind(act); }));
		main.play();

		function checkForUpdate()
		{
			if (window.applicationCache)
				window.applicationCache.addEventListener('updateready', updateApplication);
		}

		function updateApplication(event)
		{
		    if (window.applicationCache.status != 4)
		    		return;

			window.applicationCache.removeEventListener('updateready', updateApplication);
			window.applicationCache.swapCache();
			window.location.reload();
		}

		checkForUpdate();

		</script>
	</body>
</html>